# ğŸ”„ Alembic Setup & Usage Guide - PingLayer

## âœ… **Alembic is Now Configured!**

Alembic is set up and ready to manage your database migrations.

---

## ğŸ“‹ **What Was Configured**

### **1. `alembic/env.py`** - Environment Configuration
- âœ… Imports all your models automatically
- âœ… Uses `DATABASE_URL` from your `.env` file
- âœ… Detects column type changes
- âœ… Detects default value changes
- âœ… Ready for autogenerate

### **2. `alembic.ini`** - Alembic Configuration
- âœ… Configured for PostgreSQL
- âœ… Uses settings from env.py
- âœ… Logging configured

---

## ğŸš€ **Quick Start**

### **Step 1: Create Initial Migration**

This creates a migration with all your current tables:

```bash
# From backend directory
alembic revision --autogenerate -m "Initial migration"
```

**What this does**:
- Scans all your models (User, Company, Campaign, etc.)
- Compares with current database
- Generates migration file in `alembic/versions/`

### **Step 2: Apply Migration**

```bash
alembic upgrade head
```

**What this does**:
- Runs the migration
- Creates all tables in database
- Updates alembic_version table

### **Step 3: Verify**

```bash
alembic current
```

Shows the current migration version.

---

## ğŸ“ **Common Commands**

### **Create a New Migration**

After changing models (adding fields, new tables, etc.):

```bash
alembic revision --autogenerate -m "Add email_verified field to users"
```

### **Apply Migrations**

```bash
# Upgrade to latest
alembic upgrade head

# Upgrade one version
alembic upgrade +1

# Upgrade to specific version
alembic upgrade abc123
```

### **Rollback Migrations**

```bash
# Downgrade one version
alembic downgrade -1

# Downgrade to specific version
alembic downgrade abc123

# Downgrade all (back to empty database)
alembic downgrade base
```

### **View Migration History**

```bash
# Show current version
alembic current

# Show migration history
alembic history

# Show verbose history
alembic history --verbose
```

### **Check Pending Migrations**

```bash
# Show what migrations haven't been applied
alembic current
alembic heads
```

---

## ğŸ¯ **Complete Workflow Example**

### **Scenario: Add a New Field to User Model**

#### **1. Modify the Model**

Edit `app/models/user.py`:

```python
class User(Base):
    # ... existing fields ...
    
    # Add new field
    phone_number = Column(String(20), nullable=True)
```

#### **2. Generate Migration**

```bash
alembic revision --autogenerate -m "Add phone_number to users"
```

**Output**:
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added column 'users.phone_number'
  Generating C:\...\alembic\versions\abc123_add_phone_number_to_users.py ...  done
```

#### **3. Review the Migration**

Open `alembic/versions/abc123_add_phone_number_to_users.py`:

```python
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('users', sa.Column('phone_number', sa.String(length=20), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('users', 'phone_number')
    # ### end Alembic commands ###
```

#### **4. Apply the Migration**

```bash
alembic upgrade head
```

**Output**:
```
INFO  [alembic.runtime.migration] Running upgrade abc123 -> def456, Add phone_number to users
```

#### **5. Verify**

```bash
alembic current
```

**Output**:
```
def456 (head)
```

Done! âœ…

---

## ğŸ”§ **Advanced Usage**

### **Create Empty Migration (Manual)**

For complex changes that autogenerate can't handle:

```bash
alembic revision -m "Custom migration"
```

Then edit the file manually.

### **Merge Multiple Heads**

If you have multiple migration branches:

```bash
alembic merge -m "Merge branches" head1 head2
```

### **Stamp Database**

Mark database as being at a specific version without running migrations:

```bash
alembic stamp head
```

Useful when:
- Manually created tables
- Importing existing database
- Syncing migration state

---

## ğŸ“Š **Migration File Structure**

### **Location**
```
backend/
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ versions/
â”‚   â”‚   â”œâ”€â”€ abc123_initial_migration.py
â”‚   â”‚   â”œâ”€â”€ def456_add_phone_number.py
â”‚   â”‚   â””â”€â”€ ghi789_add_email_verified.py
â”‚   â”œâ”€â”€ env.py
â”‚   â””â”€â”€ script.py.mako
â”œâ”€â”€ alembic.ini
â””â”€â”€ ...
```

### **Migration File Example**

```python
"""Add phone_number to users

Revision ID: def456
Revises: abc123
Create Date: 2024-07-01 10:00:00.000000

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'def456'
down_revision: Union[str, None] = 'abc123'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # Add column
    op.add_column('users', sa.Column('phone_number', sa.String(length=20), nullable=True))


def downgrade() -> None:
    # Remove column
    op.drop_column('users', 'phone_number')
```

---

## âš ï¸ **Important Notes**

### **1. Always Review Auto-Generated Migrations**

Alembic's autogenerate is smart but not perfect. Always review before applying:

```bash
# Generate
alembic revision --autogenerate -m "My changes"

# Review the file in alembic/versions/

# Apply only if it looks correct
alembic upgrade head
```

### **2. Backup Before Major Migrations**

```bash
# Backup database
pg_dump pinglayer > backup_$(date +%Y%m%d).sql

# Then run migration
alembic upgrade head
```

### **3. Test Migrations in Development First**

```bash
# Development
alembic upgrade head

# Test your app

# If good, apply to production
# Production
alembic upgrade head
```

### **4. Migrations are One-Way in Production**

Once applied in production, don't:
- âŒ Delete migration files
- âŒ Modify applied migrations
- âŒ Change migration order

Instead:
- âœ… Create new migration to fix issues
- âœ… Use downgrade if needed
- âœ… Keep migration history intact

---

## ğŸ› **Troubleshooting**

### **Error: "Can't locate revision identified by 'abc123'"**

**Solution**: The migration file is missing or deleted.

```bash
# Check what migrations exist
ls alembic/versions/

# Check database version
alembic current

# If mismatch, stamp to correct version
alembic stamp head
```

### **Error: "Target database is not up to date"**

**Solution**: Apply pending migrations.

```bash
alembic upgrade head
```

### **Error: "Multiple head revisions are present"**

**Solution**: Merge the heads.

```bash
alembic merge -m "Merge heads" heads
alembic upgrade head
```

### **Autogenerate Doesn't Detect Changes**

**Checklist**:
- âœ… Model is imported in `alembic/env.py`
- âœ… Model inherits from `Base`
- âœ… Model is in `app/models/__init__.py`
- âœ… Database is up to date

```bash
# Force detection
alembic revision --autogenerate -m "Force detection"
```

---

## ğŸ“š **Best Practices**

### **1. Descriptive Migration Names**

```bash
# Good âœ…
alembic revision --autogenerate -m "Add email_verified field to users"
alembic revision --autogenerate -m "Create campaigns table"
alembic revision --autogenerate -m "Add index on user email"

# Bad âŒ
alembic revision --autogenerate -m "Update"
alembic revision --autogenerate -m "Fix"
alembic revision --autogenerate -m "Changes"
```

### **2. One Logical Change Per Migration**

```bash
# Good âœ…
alembic revision --autogenerate -m "Add phone_number to users"
alembic revision --autogenerate -m "Add email_verified to users"

# Bad âŒ
alembic revision --autogenerate -m "Add phone and email and fix indexes"
```

### **3. Test Both Upgrade and Downgrade**

```bash
# Test upgrade
alembic upgrade head

# Test downgrade
alembic downgrade -1

# Re-upgrade
alembic upgrade head
```

### **4. Keep Migrations in Version Control**

```bash
git add alembic/versions/abc123_*.py
git commit -m "Add migration: Add phone_number to users"
git push
```

---

## ğŸ¯ **Quick Reference**

| Command | Description |
|---------|-------------|
| `alembic revision --autogenerate -m "msg"` | Create new migration |
| `alembic upgrade head` | Apply all pending migrations |
| `alembic downgrade -1` | Rollback one migration |
| `alembic current` | Show current version |
| `alembic history` | Show migration history |
| `alembic stamp head` | Mark DB as current without migrating |

---

## ğŸš€ **Next Steps**

### **1. Create Initial Migration**

```bash
cd backend
alembic revision --autogenerate -m "Initial migration - all tables"
```

### **2. Review the Migration**

Check `alembic/versions/` for the new file.

### **3. Apply It**

```bash
alembic upgrade head
```

### **4. Verify**

```bash
alembic current
```

---

## ğŸ“ **Example: Complete Migration Workflow**

```bash
# 1. Make changes to models
# Edit app/models/user.py

# 2. Generate migration
alembic revision --autogenerate -m "Add phone_number to users"

# 3. Review migration file
# Check alembic/versions/abc123_add_phone_number_to_users.py

# 4. Apply migration
alembic upgrade head

# 5. Verify
alembic current

# 6. Test your app
python -m pytest

# 7. Commit
git add alembic/versions/abc123_*.py
git commit -m "Add phone_number field to users"
```

---

**Alembic is ready! Start creating migrations! ğŸ‰**
